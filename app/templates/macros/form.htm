{% from "macros/custom_form.htm" import custom_form_select %}

{% macro _render_field_with_errors(field, field_input_html, show_cross=True) %}
    <div class="form-group{% if field.errors %} has-error has-feedback{% endif %}">
        <div class="col-sm-12">
            {{ field.label }}
        </div>
        <div class="col-sm-12">
            {{ field_input_html }}
            {%- if field.errors -%}
            {%- if show_cross -%}
            <i class="glyphicon glyphicon-remove form-control-feedback"></i>
            {%- endif -%}
            {%- for error in field.errors -%}
            <p class="help-block">{{ error }}</p>
            {%- endfor -%}
            {%- endif -%}
        </div>
    </div>
{% endmacro %}

{% macro render_field(field) %}
    {{ _render_field_with_errors(field, field(placeholder=field.label.text, class='form-control')) }}
{% endmacro %}

{% macro render_button(field, cls='btn btn-default') %}
    {{ field(class=cls) }}
{% endmacro %}

{% macro render_submit(text) %}
    <div class="form-group">
        <div class="col-sm-12">
            <button class='btn btn-primary' data-loading-text={{_('Loading...')}}
                type='submit'>{{ text }}</button>
        </div>
    </div>
{% endmacro %}

{% macro render_checkbox(field) %}
    <div class="form-group">
        <div class="col-sm-12">
            <div class="checkbox">
                <label>
                    {{ field }}
                    {{ field.label.text }}
                </label>
            </div>
        </div>
    </div>
{% endmacro %}

{% macro render_textarea(field) %}
    {{ _render_field_with_errors(field, field(placeholder=field.label.text, class='form-control',
                cols='50', rows='50')) }}
{% endmacro %}

{% macro _render_number_input(field, step) %}
<input class="form-control" type="number" step="{{ step }}" placeholder="{{ field.label.text }}" name="{{ field.name }}"{% if field.data %} value="{{ field.data }}"{%endif%} />
{% endmacro %}

{% macro render_integer(field) %}
    {{ _render_field_with_errors(field, _render_number_input(field, 1)) }}
{% endmacro %}

{% macro render_decimal(field) %}
    {{ _render_field_with_errors(field, _render_number_input(field, "any")) }}
{% endmacro %}

{% macro render_datefield(field) %}
    <div class="form-group">
        {{ field.label }}
        {{ field(class='form-control', **{'data-date-format': 'yyyy-mm-dd hh:ii'}) }}
    </div>
{% endmacro %}

{% macro _render_datetimefield_inputgroup(field, format) %}
    <div class='input-group date' id='{{field.id}}'>
        <span class="input-group-addon"><i class="fa fa-clock-o"></i></span>
        {{ field(class='form-control', placeholder=format, **{'data-date-format': '{{ format }}'}) }}
    </div>
{% endmacro %}

<!-- Render with date and time -->
{% macro render_datetimefield_picker(field) %}
{{ _render_field_with_errors(field, _render_datetimefield_inputgroup(field, 'yyyy-mm-dd hh:ii')) }}
    <script>$("#{{ field.id }}").datetimepicker({ format: 'yyyy-mm-dd hh:ii' });</script>
{% endmacro %}

<!-- Render with date only -->
{% macro render_datefield_picker(field) %}
{{ _render_field_with_errors(field, _render_datetimefield_inputgroup(field, 'yyyy-mm-dd')) }}
    <script>$("#{{ field.id }}").datetimepicker({ format: 'yyyy-mm-dd' });</script>
{% endmacro %}

{% macro render_select(field) %}
{{ _render_field_with_errors(field, field(class='form-control'), False) }}
{% endmacro %}

{# TODO Remove once done #}
{% macro render_file(field) %}
{{ render_field(field) }}
{% endmacro %}

{# TODO Remove once done #}
{% macro render_education_select_orig(field, educations, selected=None, redir=None) %}
<div class='form-group'>
    {{ field.label }}
    <div class='input-group'>
        <select id='{{ field.id }}' name='{{ field.name }}' class='form-control'>
            {% for education in educations %}
            <option value="{{ education.id }}"
                {%- if selected and education.id == selected.id %} selected="selected"{% endif -%}>
                {{education.name}}
            </option>
            {% endfor %}
        </select>
        <span class="input-group-btn">
            <a href="/education/add{% if redir %}?redir={{ redir }}{% endif %}" class="btn btn-default btn-success">
                <i class="glyphicon glyphicon-pencil"></i>
                {{_('New education')}}
            </a>
        </span>
    </div>
</div>
{% endmacro %}

{# TODO Remove once done #}
{% macro render_course_select_orig(field, courses, selected=None, redir=None) %}
<div class='form-group'>
    {{ field.label }}
    <div class='input-group'>
        <select id='{{ field.id }}' name='{{ field.name }}' class='form-control'>
            {% for course in courses %}
            <option value="{{ course.id }}"
                {%- if selected and course.id == selected.id %} selected="selected"{% endif -%}>
                {{course.name}}
            </option>
            {% endfor %}
        </select>
        <span class="input-group-btn">
            <a href="/courses/add{% if redir %}?redir={{ redir }}{% endif %}" class="btn btn-default btn-success">
                <i class="glyphicon glyphicon-pencil"></i>
                {{_('New course')}}
            </a>
        </span>
    </div>
</div>
{% endmacro %}


{% macro render_custom_form_selecter(field) %}
{{ _render_field_with_errors(field, custom_form_select(field.name, field.data, field.id), False) }}
{% endmacro %}

{% macro _render_select_options(field) %}
    <select id='{{ field.id }}' name='{{ field.name }}' class='form-control'>
    {% for value, label, selected in field.iter_choices() %}
    <option value="{{ value }}" {%- if selected -%}selected="selected"{%- endif -%}>
        {{ label }}
    </option>
    {% endfor %}
    </select>
{% endmacro %}

{% macro _render_course_select_inputgroup(field) %}
    <div class='input-group'>
        {{ _render_select_options(field) }}
        <span class="input-group-btn">
            <a href="{{ url_for('examination.add_course') }}" class="btn btn-default btn-success">
                <i class="glyphicon glyphicon-pencil"></i>
                {{_('New course')}}
            </a>
        </span>
    </div>
{% endmacro %}

{% macro render_course_select(field) %}
{{ _render_field_with_errors(field, _render_course_select_inputgroup(field), False) }}
{% endmacro %}

{% macro _render_education_select_inputgroup(field) %}
    <div class='input-group'>
        {{ _render_select_options(field) }}
        <span class="input-group-btn">
            <a href="{{ url_for('examination.add_education') }}" class="btn btn-default btn-success">
                <i class="glyphicon glyphicon-pencil"></i>
                {{_('New education')}}
            </a>
        </span>
    </div>
{% endmacro %}

{% macro render_education_select(field) %}
{{ _render_field_with_errors(field, _render_education_select_inputgroup(field), False) }}
{% endmacro %}

{% macro _render_radiobuttons_list(field) %}
{% for value, label, selected in field.iter_choices() %}
<div class="radio">
    <label>
        <input type="radio" name="{{ field.name }}" value="{{ value }}" {%- if selected -%}checked="checked"{%- endif -%}>
        {{ label }}
    </label>
</div>
{% endfor %}
{% endmacro %}

{% macro render_radio_buttons(field) %}
{{ _render_field_with_errors(field, _render_radiobuttons_list(field), False) }}
{% endmacro %}

{% macro render_recaptcha(field) %}
    <div class="form-group{% if field.errors %} has-error has-feedback{% endif %}">
        <div class="col-sm-12">
            {{ field(class='form-control') }}
            {%- if field.errors -%}
            <p class="help-block">{{ _("Please verify that you are not a robot.") }}</p>
            {%- endif -%}
        </div>
    </div>
{% endmacro %}

{% macro render_tabs(field, extra_field_renderers) %}
{# We use this group id in the ids of the tabs, to make them unique for this group #}
{%- set group_id = field.hex_id -%}
<div class="row">
    <div class="col-md-12">
        <div class="panel with-nav-tabs panel-default">
            <div class="panel-heading">
                <ul class="nav nav-tabs">
                    {%- for i, (tab_name, _) in enumerate(field) -%}
                    <li{% if i == 0 %} class="active"{% endif %}>
                        <a data-toggle="tab" href="#tab_{{ group_id }}_{{ i }}">
                            {{ tab_name }}
                        </a>
                    </li>
                    {%- endfor -%}
                </ul>
            </div>
            <div class="panel-body">
                <div class="tab-content">
                    {%- for i, (tab_name, tab_fields) in enumerate(field) %}
                    <div id="tab_{{ group_id }}_{{ i }}" class="tab-pane fade{% if i == 0 %} in active{% endif %}">
                        {%- for field in tab_fields -%}
                        {{ _render_field_internal(field, extra_field_renderers) }}
                        {%- endfor -%}
                    </div>
                    {%- endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_vsplit(vsplit, extra_field_renderers) %}
{%- set column_size = 12 // vsplit.amount_splits -%}
<div class="row">
{% for field_list in vsplit %}
    <div class="col-md-{{ column_size }}">
        {% for field in field_list %}
        {{ _render_field_internal(field, extra_field_renderers) }}
        {% endfor %}
    </div>
{% endfor %}
</div>
{% endmacro %}

{% macro _render_field_internal(f, extra_field_renderers) %}
    {%- if f.type in extra_field_renderers -%}
        {{ extra_field_renderers[f.type](f) }}
    {%- elif f.type == 'BooleanField' -%}
        {{ render_checkbox(f) }}
    {%- elif f.type == 'CustomFormSelectField' -%}
        {{ render_custom_form_selecter(f) }}
    {%- elif f.type == 'DateField' -%}
        {{ render_datefield_picker(f) }}
    {%- elif f.type == 'DateTimeField' -%}
        {{ render_datetimefield_picker(f) }}
    {%- elif f.type == 'DecimalField' -%}
        {{ render_decimal(f) }}
    {%- elif f.type == 'IntegerField' -%}
        {{ render_integer(f) }}
    {%- elif f.type == 'RadioField' -%}
        {{ render_radio_buttons(f) }}
    {%- elif f.type == 'SelectField' -%}
        {{ render_select(f) }}
    {%- elif f.type == 'SubmitField' -%}
        {{ render_button(f) }}
    {%- elif f.type == 'TextAreaField' -%}
        {{ render_textarea(f) }}
    {%- elif f.type == 'CourseSelectField' -%}
        {{ render_course_select(f) }}
    {%- elif f.type == 'EducationSelectField' -%}
        {{ render_education_select(f) }}
    {%- elif f.type == 'FieldTabGroup' -%}
        {{ render_tabs(f, extra_field_renderers) }}
    {%- elif f.type == 'FieldVerticalSplit' -%}
        {{ render_vsplit(f, extra_field_renderers) }}
    {%- elif f.type == 'RecaptchaField' -%}
        {{ render_recaptcha(f) }}
    {%- elif f.type != 'CSRFTokenField' -%}
        {{ render_field(f) }}
    {%- endif -%}
{% endmacro %}

{% macro render_form(form, action,
                     form_id='', form_class='form-horizontal',
                     submit_id='', submit_text='',
                     extra_field_renderers={}, submit_renderer=None) %}
{%- set form_wrapped = FormWrapper(form) -%}
<form method="POST" action="{{ action }}" enctype="multipart/form-data" class="{{ form_class }}">
    {{ form_wrapped.csrf_token }}
    {%- for f in form_wrapped -%}
    {{ _render_field_internal(f, extra_field_renderers) }}
    {%- endfor -%}
    {%- if not submit_text or submit_text == '' -%}
    {%- set submit_text = _('Submit') -%}
    {%- endif -%}
    {%- if not form_wrapped.has_submit_field -%}
    {%- if submit_renderer -%}
    {{ submit_renderer() }}
    {%- else -%}
    {{ render_submit(submit_text) }}
    {%- endif -%}
    {%- endif -%}
    {%- if form_wrapped.has_select_fields -%}
    {{ enable_select2() }}
    {%- endif -%}
    {%- if form_wrapped.has_custom_form_fields -%}
    <script src='{{static_url('/static/js/custom_form/loader.js')}}'></script>
    {%- endif -%}
</form>
{% endmacro %}

{% macro enable_select2() %}
<script type='text/javascript'>
    $(function () {
        'use strict';
        $("select").select2();
    });
</script>
{% endmacro %}
